{% extends "base.html" %}
{% block title %}{{ pt_data['name'] }} ASL{% endblock %}

{% block head %}
    {% import "views/pt_detail_input.html" as pt %}
{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/asl.css') }}">
{% endblock %}

{% block scripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.3/html2pdf.bundle.min.js" integrity="sha512-yu5WG6ewBNKx8svICzUA01vozhmiQCVfzjzW40eCHJdsDRaOifh9hPlWBDex5b32gWCzawTp1F3FJz60ps6TnQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="{{ url_for('static', filename='js/print_script.js') }}"></script>
    <script src="{{ url_for('static', filename='js/asl.js') }}"></script>
    <script src="{{ url_for('static', filename='js/asl_export.js') }}"></script>

    <script>
        const pt_id = {{ patient_id }};
        const pt_data = {{ pt_data|tojson }};
        const flatted_pt_data = flatten_dict(pt_data);
    </script>
{% endblock %}

{% block body %}
<div class="container">
    <div class="row mb-3">
        <div class="col">
            <a href="{{ url_for('views.patient_dashboard') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i>
                {% if user_role == "teacher" %}
                    Back to Patient Dashboard
                {% else %}
                    Back to Student Dashboard
                {% endif %}
            </a>
        </div>
    </div>
    
    <h2>Active Script List</h2>
    
    <!-- Patient Details Card -->
    <div class="row">
        <div id="customer-details" class="col">
            <div class="card card-body customer-card">
                <div class="row">
                    <h3>Customer Details (ASL)</h3>
                </div>
                <div class="row">
                    <div class="col">
                        <h4>Name</h4>
                        <p>{{ pt_data['name'] }}</p>
                    </div>
                    <div class="col">
                        <h4>Date of Birth</h4>
                        <p>{{ pt_data['dob'] }}</p>
                    </div>
                    <div class="col">
                        <h4>Address</h4>
                        <p>{{ pt_data['address-1'] }} {{ pt_data['address-2'] }}</p>
                    </div>
                </div>
                <div class="row">
                    <h4>Preferred Contact</h4>
                    <p>{{ pt_data['preferred-contact'] }}</p>
                </div>
            </div>
        </div>
        
        <!-- ASL Information Card -->
        <div id="asl-info" class="col">
            <div class="card card-body asl-card">
                <div class="row">
                    <h3>ASL Information</h3>
                </div>
                <div class="row">
                    <div class="col">
                        <h4>Status</h4>
                        <p>{{ pt_data['consent-status']['status'] }}</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <h4>Consent Status</h4>
                        <p>{{ pt_data['consent-status']['status'] }}</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <h4>Last Updated</h4>
                        <p>{{ pt_data['consent-status']['last-updated'] }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons Section -->
    <div class="row mt-4 mb-3">
        <div class="col">
            <div class="btn-group" role="group">
                <!-- Export Complete ASL Button -->
                     <a href="{{ url_for('views.export_asl_csv', patient_id=patient_id) }}" 
                   class="btn btn-success"
                   title="Export complete ASL and ALR as CSV">
                    <i class="bi bi-file-earmark-spreadsheet"></i> Export Complete ASL
                </a>
                
                <!-- Export Selected Button -->
                <button type="button" 
                        class="btn btn-outline-success" 
                        id="exportSelectedBtn"
                        onclick="exportSelectedPrescriptions({{ patient_id }})"
                        title="Export only selected prescriptions">
                    <i class="bi bi-file-earmark-spreadsheet"></i> Export Selected
                </button>
                
                <!-- Existing Print Button (if you have one) -->
                <button type="button" class="btn btn-primary" id="printBtn">
                    <i class="bi bi-printer"></i> Print
                </button>
            </div>
            
            <!-- Info text for selection -->
            <small class="text-muted d-block mt-2">
                <i class="bi bi-info-circle"></i> Select prescriptions below and click "Export Selected" to export specific items
            </small>
        </div>
    </div>

    <!-- ASL Scripts Section -->
    {% if pt_data['can_view_asl'] %}
    <div class="row mt-4">
        <div class="col">
            <h3>ASL Scripts</h3>
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="asl-table">
                    <thead class="table-light">
                        <tr>
                            <th><input type="checkbox" id="selectAllASL"></th>
                            <th>Prescribed</th>
                            <th>Item</th>
                            <th>Qty</th>
                            <th>Prescriber</th>
                            <th>Rpt</th>
                            <th>Paperless</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in pt_data['asl-data'] %}
                        <tr>
                            <td><input type="checkbox" class="prescription-select" name="prescription_select" value="{{ item['prescription_id'] }}"></td>
                            <td>{{ item['prescribed-date'] }}</td>
                            <td>
                                <strong>{{ item['drug-name'] }}</strong><br>
                                <small class="text-muted">{{ item['dose-instr'] }}</small><br>
                                <small class="text-muted">Code: {{ item['drug-code'] }}</small>
                            </td>
                            <td>{{ item['dose-qty'] }}</td>
                            <td>
                                {{ item['prescriber']['fname'] }} {{ item['prescriber']['lname'] }}<br>
                                <small class="text-muted">ID: {{ item['prescriber']['prescriber-id'] }}</small>
                            </td>
                            <td>{{ item['dose-rpt'] }}</td>
                            <td>
                                {% if item['paperless'] %}
                                    <span class="badge bg-success">Yes</span>
                                {% else %}
                                    <span class="badge bg-secondary">No</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="viewPrescriptionDetails({{ item['prescription_id'] }})">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Dispense button - shows when prescriptions are selected -->
    <div class="row mt-3">
        <div class="col-12 text-end">
            <button id="dispense-selected" class="btn btn-success d-none">
                <i class="bi bi-capsule"></i> Dispense Selected
            </button>
        </div>
    </div>

    <!-- ALR Section -->
    <div class="row mt-4">
        <div class="col">
            <h3>Available Local Repeats (ALR)</h3>
        <table id="alr-table" class="table collapse show">
            <thead>
                <tr>
                    <th scope="col">Dispensed</th>
                    <th scope="col">Item</th>
                    <th scope="col">Qty</th>
                    <th scope="col">Prescribed</th>
                    <th scope="col">Rpt</th>
                    <th scope="col">Paperless</th>
                </tr>
            </thead>
            <tbody>
                {% for alr in pt_data['alr-data'] %}
                <tr id="alr-{{ loop.index }}" class="alr-{{ 'paperless' if alr['paperless'] else 'paper' }}">
                    <td class="alr-date">{{ alr['dispensed-date'] or "" }}</td>
                    <td class="alr-item">
                        {{ alr['drug-name'] }}
                        <p>{{ alr['dose-instr'] }}</p>
                    </td>
                    <td class="alr-qty">{{ alr['dose-qty'] }}</td>
                    <td class="alr-prescriber">
                        {{ alr['prescriber']['lname'] }}, {{ alr['prescriber']['fname'][0] }}<br>
                        {{ alr['prescribed-date'] }}
                    </td>
                    <td class="alr-rpt">{{ alr.get('remaining-repeats', 'N/A') }}</td>
                    <td class="alr-cloud-prescription">
                        <img src="{{ url_for('static', filename='cloud-prescription.svg') }}"/>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
    </div>
    {% else %}
    <div class="alert alert-warning mt-4" role="alert">
        <h4 class="alert-heading">Access Restricted</h4>
        <p>You cannot view this patient's Active Script List. Consent status: <strong>{{ pt_data['consent-status']['status'] }}</strong></p>
        <hr>
        <p class="mb-0">Please ensure the patient has granted consent to view their ASL records.</p>
    </div>
    {% endif %}

    <!-- Close Button -->
    <div class="row mt-4 mb-4">
        <div class="col">
            <a href="{{ url_for('views.patient_dashboard') }}" class="btn btn-secondary">
                <i class="bi bi-x-circle"></i> Close
            </a>
        </div>
    </div>
</div>

<!-- Hidden form for CSRF token -->
<form id="exportForm" method="POST" class="d-none">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="prescription_ids" id="prescriptionIds">
</form>

<!-- Dispensing Modal -->
<div class="modal fade" id="dispensingModal" tabindex="-1" aria-labelledby="dispensingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dispensingModalLabel">
                    <i class="bi bi-capsule"></i> Dispense Prescriptions
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="selected-prescriptions">
                    <!-- Selected prescriptions will be populated here -->
                </div>
                <form id="dispensing-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="patient_id" value="{{ patient_id }}">
                    <input type="hidden" id="prescription-ids" name="prescription_ids" value="">
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="dispensed_by" class="form-label">Dispensed By</label>
                            <input type="text" class="form-control" id="dispensed_by" name="dispensed_by" 
                                   value="{{ current_user.get_full_name() if current_user.is_authenticated else '' }}" required>
                        </div>
                        <div class="col-md-6">
                            <label for="dispensed_date" class="form-label">Dispensed Date</label>
                            <input type="text" class="form-control" id="dispensed_date" name="dispensed_date" 
                                   value="" required>
                        </div>
                        <div class="col-12">
                            <label for="dispensing_notes" class="form-label">Dispensing Notes</label>
                            <textarea class="form-control" id="dispensing_notes" name="dispensing_notes" 
                                      rows="3" placeholder="Add any notes about the dispensing..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirm-dispense">
                    <i class="bi bi-check-circle"></i> Confirm Dispensing
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}